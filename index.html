<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --background-color: #f4f4f9;
            --text-color: #333;
            --card-background: #fff;
            --nav-background: #e0e0e0;
            --header-footer-background: #d0d0d0;
            --card-shadow: rgba(0, 0, 0, 0.1);
            --button-text-color: #333;
            --button-background-color: transparent;
            --button-border-color: #333;
        }

        body.dark-mode {
            --background-color: #121212;
            --text-color: #ffffff;
            --card-background: #1e1e1e;
            --nav-background: #232323;
            --header-footer-background: #1e1e1e;
            --card-shadow: rgba(0, 0, 0, 0.3);
            --button-text-color: #ffffff;
            --button-background-color: transparent;
            --button-border-color: #ffffff;
        }

        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
        }

        header,
        footer {
            background-color: var(--header-footer-background);
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid var(--card-shadow);
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #555;
            /* Darker text color */
        }

        header h1 {
            margin: 0;
            color: var(--text-color);
        }

        .button-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #nav-toggle,
        #theme-toggle {
            background-color: var(--button-background-color);
            border: 2px solid var(--button-border-color);
            border-radius: 5px;
            color: var(--button-text-color);
            padding: 5px 10px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            font-size: 18px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        #nav-toggle:hover,
        #theme-toggle:hover {
            background-color: var(--button-border-color);
            color: var(--background-color);
        }

        main {
            display: grid;
            grid-template-columns: 0.2fr 3.8fr;
            /* Adjusted nav width */
            grid-gap: 10px;
            padding: 20px;
            overflow-y: auto;
        }

        nav {
            background-color: var(--nav-background);
            padding: 5px;
            /* Reduced padding */
            border-right: 1px solid var(--card-shadow);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        nav ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        nav ul li {
            padding: 8px;
            /* Reduced padding */
            text-align: center;
            border-bottom: 1px solid var(--card-shadow);
            font-size: 14px;
            /* Reduced font size */
        }

        nav ul li:hover {
            background-color: #ddd;
        }

        nav ul li a {
            text-decoration: none;
            color: var(--text-color);
            display: block;
            cursor: pointer;
        }

        section {
            background-color: var(--card-background);
            padding: 20px;
            box-shadow: 0 0 10px var(--card-shadow);
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .card {
            background-color: var(--card-background);
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 0 5px var(--card-shadow);
            border-radius: 5px;
        }

        .card h3 {
            margin: 0 0 10px;
            color: var(--text-color);
        }

        .card p {
            margin: 0;
            color: #666;
        }

        .data-display {
            margin-top: 20px;
            font-size: 14px;
            white-space: pre-wrap;
            background-color: var(--nav-background);
            padding: 10px;
            border-radius: 5px;
            color: var(--text-color);
            border: 1px solid var(--card-shadow);
        }

        #default-content {
            display: block;
        }

        #test-content,
        #contact-content,
        #stream-content,
        #gallery-content {
            display: none;
        }

        .contact-form {
            display: flex;
            flex-direction: column;
        }

        .contact-form input,
        .contact-form textarea,
        .contact-form button {
            margin-bottom: 10px;
            padding: 10px;
            font-size: 14px;
            border: 1px solid var(--card-shadow);
            border-radius: 5px;
            outline: none;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .contact-form button {
            background-color: var(--button-background-color);
            border: 2px solid var(--button-border-color);
            color: var(--button-text-color);
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            font-size: 16px;
            border-radius: 5px;
            width: 100%;
        }

        .contact-form button:hover {
            background-color: var(--button-border-color);
            color: var(--background-color);
        }

        .stream-image {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 0 5px var(--card-shadow);
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
            }

            #nav-toggle {
                display: block;
                margin-right: 10px;
            }

            nav {
                display: none;
            }

            nav ul {
                flex-direction: column;
            }

            main {
                grid-template-columns: 1fr;
            }

            nav ul li {
                border-bottom: 1px solid var(--card-shadow);
            }

            nav ul li:hover {
                background-color: #ddd;
            }

            nav ul li a {
                color: var(--text-color);
            }

            .button-container {
                justify-content: center;
            }
        }

        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--nav-background);
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--button-border-color);
            border-radius: 10px;
            border: 3px solid var(--nav-background);
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--text-color);
        }

        /* Firefox Scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--button-border-color) var(--nav-background);
        }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const navLinks = document.querySelectorAll('nav ul li a');
            const defaultContent = document.getElementById('default-content');
            const testContent = document.getElementById('test-content');
            const contactContent = document.getElementById('contact-content');
            const streamContent = document.getElementById('stream-content');
            const galleryContent = document.getElementById('gallery-content');
            const dataDisplay = document.querySelector('.data-display');
            const themeToggle = document.getElementById('theme-toggle');
            const navToggle = document.getElementById('nav-toggle');
            const nav = document.querySelector('nav');
            const main = document.querySelector('main');
            const timestampSelectors = document.getElementById('timestamp-selectors');
            const selectedImage = document.getElementById('selected-image');
            let streamInterval;

            // Load theme from localStorage
            const currentTheme = localStorage.getItem('theme') || 'light';
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }

            navLinks.forEach(link => {
                link.addEventListener('click', function () {
                    const target = this.getAttribute('data-target');

                    defaultContent.style.display = 'none';
                    testContent.style.display = 'none';
                    contactContent.style.display = 'none';
                    streamContent.style.display = 'none';
                    galleryContent.style.display = 'none';

                    clearInterval(streamInterval); // Clear any existing interval

                    if (target === 'test') {
                        testContent.style.display = 'block';

                        fetch('/api/data')
                            .then(response => response.json())
                            .then(data => {
                                dataDisplay.textContent = JSON.stringify(data, null, 2);
                            })
                            .catch(error => {
                                dataDisplay.textContent = 'Error fetching data: ' + error;
                                console.error('Error fetching data:', error);
                            });
                    } else if (target === 'contact') {
                        contactContent.style.display = 'block';
                    } else if (target === 'stream') {
                        streamContent.style.display = 'block';

                        // Fetch image from the /stream endpoint 5 times a second (every 200 ms)
                        streamInterval = setInterval(() => {
                            fetch('/stream')
                                .then(response => {
                                    if (response.ok && response.headers.get('Content-Type').startsWith('image')) {
                                        return response.blob();
                                    }
                                    throw new Error('No image available');
                                })
                                .then(blob => {
                                    const url = URL.createObjectURL(blob);
                                    const img = document.createElement('img');
                                    img.src = url;
                                    img.alt = 'Streamed Image';
                                    img.className = 'stream-image';

                                    streamContent.innerHTML = ''; // Clear existing content
                                    streamContent.appendChild(img);

                                    // Revoke the URL to release memory
                                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                                })
                                .catch(error => {
                                    console.error('Error fetching image:', error);
                                    streamContent.innerHTML = '<p>No image available</p>';
                                });
                        }, 200);
                    } else if (target === 'gallery') {
                        galleryContent.style.display = 'block';
                        startImagePlayback();
                    } else {
                        defaultContent.style.display = 'block';
                    }

                    nav.style.display = 'none';
                    main.style.gridTemplateColumns = '1fr';
                });
            });

            themeToggle.addEventListener('click', function () {
                document.body.classList.toggle('dark-mode');
                const newTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
                localStorage.setItem('theme', newTheme);
            });

            navToggle.addEventListener('click', function () {
                if (nav.style.display === 'none' || nav.style.display === '') {
                    nav.style.display = 'flex';
                    main.style.gridTemplateColumns = '0.2fr 3.8fr';
                } else {
                    nav.style.display = 'none';
                    main.style.gridTemplateColumns = '1fr';
                }
            });

            function startImagePlayback() {
                fetch('/timestamps')
                    .then(response => response.json())
                    .then(data => {
                        if (data.timestamps.length > 0) {
                            playImagesSequentially(data.timestamps);
                        } else {
                            selectedImage.innerHTML = '<p>No images available</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching timestamps:', error);
                    });
            }

            function playImagesSequentially(timestamps) {
                let index = 0;
                const delay = 500; // Delay between frames (milliseconds)

                function showNextImage() {
                    if (index < timestamps.length) {
                        const timestamp = timestamps[index];
                        fetchImageByTimestamp(timestamp)
                            .then(() => {
                                index++;
                                setTimeout(showNextImage, delay);
                            });
                    }
                }

                showNextImage();
            }

            function fetchImageByTimestamp(timestamp) {
                return fetch(`/image/${encodeURIComponent(timestamp)}`)
                    .then(response => {
                        if (response.ok && response.headers.get('Content-Type').startsWith('image')) {
                            return response.blob();
                        }
                        throw new Error('Image not found');
                    })
                    .then(blob => {
                        const url = URL.createObjectURL(blob);
                        selectedImage.innerHTML = `<img src="${url}" alt="Image ${timestamp}" class="stream-image">`;
                        setTimeout(() => URL.revokeObjectURL(url), 1000);
                    })
                    .catch(error => {
                        console.error('Error fetching image:', error);
                        selectedImage.innerHTML = '<p>Image not found</p>';
                    });
            }
        });
    </script>
</head>

<body>
    <header>
        <div class="button-container">
            <button id="nav-toggle"><i class="fas fa-bars"></i></button>
            <button id="theme-toggle"><i class="fas fa-power-off"></i></button>
        </div>
    </header>
    <main>
        <nav>
            <ul>
                <li><a href="#" data-target="home" title="Home"><i class="fas fa-home"></i></a></li>
                <li><a href="#" data-target="profile" title="Profile"><i class="fas fa-user"></i></a></li>
                <li><a href="#" data-target="test" title="Test"><i class="fas fa-vial"></i></a></li>
                <li><a href="#" data-target="contact" title="Contact"><i class="fas fa-envelope"></i></a></li>
                <li><a href="#" data-target="stream" title="Stream"><i class="fas fa-play-circle"></i></a></li>
                <!-- New Gallery Tab -->
                <li><a href="#" data-target="gallery" title="Gallery"><i class="fas fa-images"></i></a></li>
                <li><a href="#" data-target="help" title="Help"><i class="fas fa-question-circle"></i></a></li>
                <li><a href="#" data-target="settings" title="Settings"><i class="fas fa-cog"></i></a></li>
                <li><a href="#" data-target="logout" title="Logout"><i class="fas fa-sign-out-alt"></i></a></li>
            </ul>
        </nav>
        <section id="default-content">
            <div class="card">
                <h3>Welcome!</h3>
                <p>This is a minimal dashboard template.</p>
            </div>
            <div class="card">
                <h3>Stats</h3>
                <p>Here you can add your dashboard statistics.</p>
            </div>
            <div class="card">
                <h3>News</h3>
                <h4>Breaking News: AI Advances in 2024</h4>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla vehicula tincidunt velit, nec
                    sollicitudin magna volutpat non. Quisque sit amet lacus orci. Fusce quis nulla nec purus varius
                    tempor. Integer vel lorem vel risus euismod eleifend. Morbi non felis et dolor laoreet eleifend.
                    Aliquam erat volutpat.</p>
                <a href="#" class="read-more">Read more...</a>
            </div>
            <div class="card">
                <h3>News</h3>
                <h4>Breaking News: AI Advances in 2024</h4>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla vehicula tincidunt velit, nec
                    sollicitudin magna volutpat non. Quisque sit amet lacus orci. Fusce quis nulla nec purus varius
                    tempor. Integer vel lorem vel risus euismod eleifend. Morbi non felis et dolor laoreet eleifend.
                    Aliquam erat volutpat.</p>
                <a href="#" class="read-more">Read more...</a>
            </div>

            <div class="card">
                <h3>News</h3>
                <h4>Breaking News: AI Advances in 2024</h4>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla vehicula tincidunt velit, nec
                    sollicitudin magna volutpat non. Quisque sit amet lacus orci. Fusce quis nulla nec purus varius
                    tempor. Integer vel lorem vel risus euismod eleifend. Morbi non felis et dolor laoreet eleifend.
                    Aliquam erat volutpat.</p>
                <a href="#" class="read-more">Read more...</a>
            </div>

            <div class="card">
                <h3>News</h3>
                <h4>Breaking News: AI Advances in 2024</h4>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla vehicula tincidunt velit, nec
                    sollicitudin magna volutpat non. Quisque sit amet lacus orci. Fusce quis nulla nec purus varius
                    tempor. Integer vel lorem vel risus euismod eleifend. Morbi non felis et dolor laoreet eleifend.
                    Aliquam erat volutpat.</p>
                <a href="#" class="read-more">Read more...</a>
            </div>
        </section>
        <section id="test-content">
            <div class="card">
                <h3>Test Data</h3>
                <p>The data fetched from the server will be displayed here:</p>
                <div class="data-display"></div>
            </div>
        </section>
        <section id="contact-content">
            <div class="card">
                <h3>Contact Us</h3>
                <form class="contact-form">
                    <input type="text" placeholder="Name" required>
                    <input type="email" placeholder="Email" required>
                    <textarea placeholder="Message" rows="4" required></textarea>
                    <button type="submit">Send</button>
                </form>
            </div>
        </section>
        <section id="stream-content">
            <div class="card">
                <h3>Live Stream</h3>
                <p>The image fetched from the stream will be displayed here:</p>
                <!-- Image will be appended here by JavaScript -->
            </div>
        </section>
        <section id="gallery-content">
            <div class="card">
                <h3>Image Gallery</h3>
                <p>The video-on-demand playback of the images will be shown here:</p>
                <div id="selected-image"></div>
            </div>
        </section>

    </main>
    <footer>
        <p>&copy; 2024. All rights reserved.</p>
    </footer>
</body>

</html>

